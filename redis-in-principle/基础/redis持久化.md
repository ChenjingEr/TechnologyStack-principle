## Redis持久化
redis不仅仅作为内存数据库，还支持持久化数据。这样再一次重启redis服务器则会加载持久化文件中的数据。Redis提供了2中持久化方式。

##### RDB
RDB方式是通过将在在内存中的数据生成一份快照持久化到磁盘上生成RDB文件(RDB中记录的是内存保存的数据)。
RDB方式是配置一个或几个检查点，只要到了这几个检查点的任何一个，就执行持久化。
在redis.config中通过save来设置检查点,且可以设置多个检查点。
```
save 900 1   //在900秒之内，对数据库至少有1次修改(增加，删除，修改)
save 300 10  //在300秒之内，对数据库至少有10次修改(增加，删除，修改)
save 60 10000 //在60秒之内，对数据库至少10000次修改(增加，删除，修改)
```

在客户端执行 save / bgsave命令也会持久化。save阻塞所有的客户端请求，bgsave是通过异步执行的
执行flushall命令也会执行持久化

* RDB执行过程(bgsave)：
    - redis 使用fork函数复制一份当前进程的副本
    - 父进程继续处理客户端请求，子进程(副本)将内存中的数据写入硬盘的临时文件
    - 子进程完成数据写入，替换旧的RDB文件

##### AOF
* AOF方式是通过将命令追加到AOF文件中来实现的持久化(AOP文件中记录的是执行过的命令)
AOF默认关闭,通过配置开启
```
appendonly yes  //默认是no
```

* AOF重写
重写配置：
```
    auto-aof-rewrite-percentage 100     aof文件大小超过上一次文件大小的100%
    auto-aop-rewrite-min-size 64mb      运行重写的最小的文件大小
```
  .此时父进程，再将新的命令追加到重写的文件之后，同时覆盖现有的AOF文件。重写结束<br>

* 同步硬盘数据
使用AOF在写入文件时，OS也存在缓存机制，并不是马上将数据写入文件中。redis可以设置同步执行的频率
```
appendsync:
    always:将写入到aof_buf的所有内容写入并同步到文件中
    everysec:将aof_buf的内容写入到文件，且每个一分钟同步一次aof文件。默认配置
    no:将aop_buf的内容写入到文件，同步由操作系统决定
```

---
数据持久化之后，用哪种方式恢复数据？ <br>
AOF开启则用AOF方式


#### RDB＆AOF

------------------------------------优点---------------------------------------------------
1. RDB持久化会生成多个数据文件，每个数据文件都代表了某一个时刻中redis的数据，这种方式适合做冷备。
2. RDB可以由redis去控制固定时长生成的文件快照，可控。AOF需要做自己写一些脚本去做这个事情。
3. RDB恢复的数据比AOF快，RDB基于数据文件来恢复。AOF是基于指令来恢复。
4. RDB是bgsave是fork一个子进程来实现持久化，AOF每次需要写文件。
-----------------------------------缺点---------------------------------------------------
1.RDB发生宕机等情况下，丢失的数据会比较多(根据条件去生成快照，但是在达到这个条件之前，可能发生宕机，那么这一段时间内的数据全部丢失)
。AOF是默认每秒fsync操作，即使宕机，逻辑上丢失1秒的数据(阻塞或其他情况导致fsync等待的情况下)